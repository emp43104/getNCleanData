## run_analysis script : Getting and Cleaning Data Course Project
##
## 1. Merge training and test sets to create one data set.
## 2.	Extract only the measurements on the mean and standard deviation for each measurement.
## 3.	Name the activities in the data set with descriptive activity names
## 4.	Appropriately label the data set with descriptive variable names.
## 5.	From the data set in step 4, creates a second, independent tidy data set with the average of each variable for each activity and each subject.

## do some preliminary initialization - set working directory, setup the RCurl package
print ("setting working directory to /sxx/coursera/rdata")
setwd("/sxx/coursera/rdata")
library(data.table)
library(plyr);

## Create the working data directory if not present
if (!file.exists("./getdata_projectfiles")){
  print ("creating data directory")
  dir.create("./getdata_projectfiles")
}
## Download and setup the data archive
fileURL <- "https://d396qusza40orc.cloudfront.net/getdata%2Fprojectfiles%2FUCI%20HAR%20Dataset.zip"
if (!file.exists("./getdata_projectfiles/Dataset.zip")){
  print ("downloading zip file")
  download.file(fileURL,destfile="./getdata_projectfiles/Dataset.zip",method="auto")
  ## download file - toggle with method curl or auto depending on operating system
}

## Unzip the data archive and check the files
print ("unzipping files...")
unzip(zipfile="./getdata_projectfiles/Dataset.zip",exdir="./getdata_projectfiles")
dataPath <- "./getdata_projectfiles/UCI HAR Dataset"

## filesList <- list.files(dataPath, recursive=TRUE)
## filesList
## [1] "activity_labels.txt"        activity levels                         
## [2] "features.txt"               feature names                                
## [3] "features_info.txt"                   
## [4] "README.txt"                                  
## [14] "test/subject_test.txt"     Subject - test                     
## [15] "test/X_test.txt"           Features - test                           
## [16] "test/y_test.txt"           Activity - test                        
## [26] "train/subject_train.txt"   Subject - train                    
## [27] "train/X_train.txt"         Features - train                           
## [28] "train/y_train.txt"         Activity - train

## Create a single data set from the files in test and train folders
## The "test" and "train" folders each have three .txt files (for activity, subject and features).
## i.e. take the three .txt files from each of the "test" and "train" folders 
## and eventually combine them into one, single data frame.

## Read files - feature names, test data and training data (activities, subject and features)

print ("reading files...")
dtTestActivity  <- read.table(file.path(dataPath,"test" , "Y_test.txt" ),        header = FALSE)
dtTestSubject   <- read.table(file.path(dataPath,"test" , "subject_test.txt"),   header = FALSE)
dtTestFeatures  <- read.table(file.path(dataPath,"test" , "X_test.txt" ),        header = FALSE)
dtTrainActivity <- read.table(file.path(dataPath,"train", "Y_train.txt"),        header = FALSE)
dtTrainSubject  <- read.table(file.path(dataPath,"train", "subject_train.txt"),  header = FALSE)
dtTrainFeatures <- read.table(file.path(dataPath,"train", "X_train.txt"),        header = FALSE)
dtFeatureNames  <- read.table(file.path(dataPath,         "features.txt"),       header = FALSE)
dtActivityLabels<- read.table(file.path(dataPath,         "activity_labels.txt"),header = FALSE)

## Merge training and test sets (just append rows) and give columns meaningful names
## for features, apply the feature names given in "features.txt" 

print ("merging data sets...")
dtActivity<- rbind(dtTestActivity, dtTrainActivity)
names(dtActivity) <- c("activity")
dtSubject <- rbind(dtTestSubject,  dtTrainSubject)
names(dtSubject)  <- c("subject")
dtFeatures<- rbind(dtTestFeatures, dtTrainFeatures)
names(dtFeatures) <- dtFeatureNames$V2

## Now create a consolidated dataset by merging all three data set into one
dtFull<- cbind(cbind(dtSubject, dtActivity), dtFeatures)

## Now name the activities with descriptive activity names. 
## apply the names given in "activity_labels.txt" to the merged data.
dtFull$activity <- factor(dtFull$activity, levels = dtActivityLabels$V1, labels = dtActivityLabels$V2)

print("checking if activity IDs have changed to activity labels")
head(dtFull$activity,15)
## [1] STANDING STANDING STANDING STANDING STANDING STANDING STANDING STANDING STANDING
## [10] STANDING STANDING STANDING STANDING STANDING STANDING 
## Levels: WALKING WALKING_UPSTAIRS WALKING_DOWNSTAIRS SITTING STANDING LAYING

## Extract only measurements for mean and stddev for each measurement
## Get subset of feature names by measurements on mean() or std() deviation
## Get subset of data for new names subset (mean(), std(), subject & activity
namesSubset <- dtFeatureNames$V2[grep("mean\\(\\)|std\\(\\)", dtFeatureNames$V2)]
namesSubset <- c("subject", "activity", as.character(namesSubset))
dataSubset <- subset(dtFull, select = namesSubset)
print("Identified data subset containing subjet, activity, and all mean & stddev columns")
str(dataSubset)

## 'data.frame':    10299 obs. of  68 variables:
## $ subject                    : int  2 2 2 2 2 2 2 2 2 2 ...
## $ activity                   : Factor w/ 6 levels "WALKING","WALKING_UPSTAIRS",..: 5 5 5 5 5 5 5 5 5 5 ...
## $ tBodyAcc-mean()-X          : num  0.257 0.286 0.275 0.27 0.275 ...
## $ tBodyAcc-mean()-Y          : num  -0.0233 -0.0132 -0.0261 -0.0326 -0.0278 ...
## ...

## Now clean up the names in the mean / stddev subset 
## . eliminate ()
## .	prefix t replaced by time
## .	prefix f replaced by frequency
## .	BodyBody changed to Body
## . mean     changed to Mean
## . std      changed to Std

names(dataSubset) <- gsub('\\(|\\)',"",names(dataSubset), perl = TRUE)
names(dataSubset) <- gsub("^t", "time", names(dataSubset))
names(dataSubset) <- gsub("^f", "freq", names(dataSubset))
names(dataSubset) <- gsub("BodyBody", "Body", names(dataSubset))
names(dataSubset) <- gsub("mean", "Mean", names(dataSubset))
names(dataSubset) <- gsub("std", "SD", names(dataSubset))

print("The cleaned up data subset containing improved naming")
str(dataSubset)
## 'data.frame':  10299 obs. of  68 variables:
## $ subject                 : int  2 2 2 2 2 2 2 2 2 2 ...
## $ activity                : Factor w/ 6 levels "WALKING","WALKING_UPSTAIRS",..: 5 5 5 5 5 5 5 5 5 5 ...
## $ timeBodyAcc-mean-X      : num  0.257 0.286 0.275 0.27 0.275 ...
## $ timeBodyAcc-mean-Y      : num  -0.0233 -0.0132 -0.0261 -0.0326 -0.0278 ...
## $ timeBodyAcc-mean-Z      : num  -0.0147 -0.1191 -0.1182 -0.1175 -0.1295 ...
## $ timeBodyAcc-std-X       : num  -0.938 -0.975 -0.994 -0.995 -0.994 ...
## $ timeBodyAcc-std-Y       : num  -0.92 -0.967 -0.97 -0.973 -0.967 ...
## $ timeBodyAcc-std-Z       : num  -0.668 -0.945 -0.963 -0.967 -0.978 ...
## $ timeGravityAcc-mean-X   : num  0.936 0.927 0.93 0.929 0.927 ...
## $ timeGravityAcc-mean-Y   : num  -0.283 -0.289 -0.288 -0.293 -0.303 ...
## $ timeGravityAcc-mean-Z   : num  0.115 0.153 0.146 0.143 0.138 ...
## $ timeGravityAcc-std-X    : num  -0.925 -0.989 -0.996 -0.993 -0.996 ...
## $ timeGravityAcc-std-Y    : num  -0.937 -0.984 -0.988 -0.97 -0.971 ...
## $ timeGravityAcc-std-Z    : num  -0.564 -0.965 -0.982 -0.992 -0.968 ...
## $ timeBodyAccJerk-mean-X  : num  0.072 0.0702 0.0694 0.0749 0.0784 ...
## $ timeBodyAccJerk-mean-Y  : num  0.04575 -0.01788 -0.00491 0.03227 0.02228 ...
## $ timeBodyAccJerk-mean-Z  : num  -0.10604 -0.00172 -0.01367 0.01214 0.00275 ...
## $ timeBodyAccJerk-std-X   : num  -0.907 -0.949 -0.991 -0.991 -0.992 ...
## $ timeBodyAccJerk-std-Y   : num  -0.938 -0.973 -0.971 -0.973 -0.979 ...
## $ timeBodyAccJerk-std-Z   : num  -0.936 -0.978 -0.973 -0.976 -0.987 ...
## $ timeBodyGyro-mean-X     : num  0.11998 -0.00155 -0.04821 -0.05664 -0.05999 ...
## $ timeBodyGyro-mean-Y     : num  -0.0918 -0.1873 -0.1663 -0.126 -0.0847 ...
## $ timeBodyGyro-mean-Z     : num  0.1896 0.1807 0.1542 0.1183 0.0787 ...
## $ timeBodyGyro-std-X      : num  -0.883 -0.926 -0.973 -0.968 -0.975 ...
## $ timeBodyGyro-std-Y      : num  -0.816 -0.93 -0.979 -0.975 -0.978 ...
## $ timeBodyGyro-std-Z      : num  -0.941 -0.968 -0.976 -0.963 -0.968 ...
## $ timeBodyGyroJerk-mean-X : num  -0.2049 -0.1387 -0.0978 -0.1022 -0.0918 ...
## $ timeBodyGyroJerk-mean-Y : num  -0.1745 -0.0258 -0.0342 -0.0447 -0.029 ...
## $ timeBodyGyroJerk-mean-Z : num  -0.0934 -0.0714 -0.06 -0.0534 -0.0612 ...
## $ timeBodyGyroJerk-std-X  : num  -0.901 -0.962 -0.984 -0.984 -0.988 ...
## $ timeBodyGyroJerk-std-Y  : num  -0.911 -0.956 -0.988 -0.99 -0.992 ...
## $ timeBodyGyroJerk-std-Z  : num  -0.939 -0.981 -0.976 -0.981 -0.982 ...
## $ timeBodyAccMag-mean     : num  -0.867 -0.969 -0.976 -0.974 -0.976 ...
## $ timeBodyAccMag-std      : num  -0.705 -0.954 -0.979 -0.977 -0.977 ...
## $ timeGravityAccMag-mean  : num  -0.867 -0.969 -0.976 -0.974 -0.976 ...
## $ timeGravityAccMag-std   : num  -0.705 -0.954 -0.979 -0.977 -0.977 ...
## $ timeBodyAccJerkMag-mean : num  -0.93 -0.974 -0.982 -0.983 -0.987 ...
## $ timeBodyAccJerkMag-std  : num  -0.896 -0.941 -0.971 -0.975 -0.989 ...
## $ timeBodyGyroMag-mean    : num  -0.796 -0.898 -0.939 -0.947 -0.957 ...
## $ timeBodyGyroMag-std     : num  -0.762 -0.911 -0.972 -0.97 -0.969 ...
## $ timeBodyGyroJerkMag-mean: num  -0.925 -0.973 -0.987 -0.989 -0.99 ...
## $ timeBodyGyroJerkMag-std : num  -0.894 -0.944 -0.984 -0.986 -0.99 ...
## $ freqBodyAcc-mean-X      : num  -0.919 -0.961 -0.992 -0.993 -0.992 ...
## $ freqBodyAcc-mean-Y      : num  -0.918 -0.964 -0.965 -0.968 -0.969 ...
## $ freqBodyAcc-mean-Z      : num  -0.789 -0.957 -0.967 -0.967 -0.98 ...
## $ freqBodyAcc-std-X       : num  -0.948 -0.984 -0.995 -0.996 -0.995 ...
## $ freqBodyAcc-std-Y       : num  -0.925 -0.97 -0.974 -0.977 -0.967 ...
## $ freqBodyAcc-std-Z       : num  -0.636 -0.942 -0.962 -0.969 -0.978 ...
## $ freqBodyAccJerk-mean-X  : num  -0.9 -0.944 -0.991 -0.991 -0.991 ...
## $ freqBodyAccJerk-mean-Y  : num  -0.937 -0.969 -0.973 -0.972 -0.98 ...
## $ freqBodyAccJerk-mean-Z  : num  -0.924 -0.973 -0.972 -0.97 -0.983 ...
## $ freqBodyAccJerk-std-X   : num  -0.924 -0.962 -0.992 -0.992 -0.994 ...
## $ freqBodyAccJerk-std-Y   : num  -0.943 -0.98 -0.971 -0.975 -0.979 ...
## $ freqBodyAccJerk-std-Z   : num  -0.948 -0.981 -0.972 -0.981 -0.989 ...
## $ freqBodyGyro-mean-X     : num  -0.824 -0.923 -0.973 -0.972 -0.976 ...
## $ freqBodyGyro-mean-Y     : num  -0.808 -0.926 -0.981 -0.981 -0.98 ...
## $ freqBodyGyro-mean-Z     : num  -0.918 -0.968 -0.972 -0.967 -0.969 ...
## $ freqBodyGyro-std-X      : num  -0.903 -0.927 -0.973 -0.967 -0.974 ...
## $ freqBodyGyro-std-Y      : num  -0.823 -0.932 -0.977 -0.972 -0.977 ...
## $ freqBodyGyro-std-Z      : num  -0.956 -0.97 -0.979 -0.965 -0.97 ...
## $ freqBodyAccMag-mean     : num  -0.791 -0.954 -0.976 -0.973 -0.978 ...
## $ freqBodyAccMag-std      : num  -0.711 -0.96 -0.984 -0.982 -0.979 ...
## $ freqBodyAccJerkMag-mean : num  -0.895 -0.945 -0.971 -0.972 -0.987 ...
## $ freqBodyAccJerkMag-std  : num  -0.896 -0.934 -0.97 -0.978 -0.99 ...
## $ freqBodyGyroMag-mean    : num  -0.771 -0.924 -0.975 -0.976 -0.977 ...
## $ freqBodyGyroMag-std     : num  -0.797 -0.917 -0.974 -0.971 -0.97 ...
## $ freqBodyGyroJerkMag-mean: num  -0.89 -0.952 -0.986 -0.986 -0.99 ...
## $ freqBodyGyroJerkMag-std : num  -0.907 -0.938 -0.983 -0.986 -0.991 ...

## Creates a second,independent tidy data set with the average of each variable and ouput it
print("preparing tidyData and writing to todyData.txt")
dataSubsetAvg = ddply(dataSubset, c("subject","activity"), numcolwise(mean))
write.table(dataSubsetAvg, file = "tidydata.txt")
print("Complete...")



